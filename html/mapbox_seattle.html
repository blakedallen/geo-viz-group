<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Display a map</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<style>
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
  
<style>
.map-overlay {
font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
position: absolute;
width: 25%;
top: 0;
left: 0;
padding: 10px;
}
 
.map-overlay .map-overlay-inner {
background-color: #fff;
box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
border-radius: 3px;
padding: 10px;
margin-bottom: 10px;
}
 
.map-overlay h2 {
line-height: 24px;
display: block;
margin: 0 0 10px;
}
 
.map-overlay .legend .bar {
height: 10px;
width: 100%;
background: linear-gradient(to right, #0000CD, #fca107);
}
  
.map-overlay input {
background-color: transparent;
display: inline-block;
width: 100%;
position: relative;
margin: 0;
cursor: ew-resize;
}

.eleInfo {
  font-family: sans-serif;
  margin-top: 5px;
  margin-left: 5px;
  padding: 5px;
  width: 200px;
  border: 2px solid black;
  font-size: 20px;
  color: #222;
  background-color: #fff;
}
</style>  
<!-- background: linear-gradient(to right, #fca107, #7f3121); -->  
<div id="map"></div>
  
<div class="map-overlay top">
<div class="map-overlay-inner">
<h2>Water Levels</h2>
<label id="month"></label>
<input id="slider" type="range" min="0" max="11" step="1" value="0" />
</div>
<div class="map-overlay-inner">
<div id="legend" class="legend">
<div class="bar"></div>
<div>Sea Rise (ft)</div>
<div class="eleInfo">
  <div>Longitude: <span id='lng'></span></div>
  <div>Latitude: <span id='lat'></span></div>
  <div>Elevation: <span id='ele'></span></div>
</div>
</div>
</div>
</div>    
  
<script>
	// TO MAKE THE MAP APPEAR YOU MUST
	// ADD YOUR ACCESS TOKEN FROM
	// https://account.mapbox.com
	mapboxgl.accessToken = 'pk.eyJ1IjoiZXNjYWRhd2ciLCJhIjoiY2tmdmdrZGhkMTYzZDJ6czMyNWo0eWZmNCJ9.XAG-cdhWcLN2IEFAP6bCbg';
var map = new mapboxgl.Map({
container: 'map', // container id
//style: 'mapbox://styles/mapbox/streets-v11', // style URL
style: 'mapbox://styles/mapbox/satellite-streets-v11',
center: [-122.44, 47.51], // starting position [lng, lat]
zoom: 9 // starting zoom
});

//actual gps coordinates used from elevation
//-122.44 47.51 -122.24 47.71
coordinates = [
  [-122.44, 47.71],
  [-122.24, 47.71],
  [-122.24, 47.51],
  [-122.44, 47.51],
];

//-122.41 --> -122.44
//47.65 --> 47.66

//stretch our image
var t_lng = 0.0335; //stretches left and right
var t_lat = 0.032; //stretches up and down

//translate top_left
coordinates[0][0] -= t_lng;
coordinates[0][1] += t_lat;

//translate top right
coordinates[1][0] += t_lng;
coordinates[1][1] += t_lat;

//translate bottom right 
coordinates[2][0] += t_lng;
coordinates[2][1] -= t_lat;

//translate bottom left
coordinates[3][0] -= t_lng;
coordinates[3][1] -= t_lat;

//scale our image coordinates
var s_lng = 1.0;
var s_lat = 1.0;

//scale top left
coordinates[0][0] *= s_lng;
coordinates[0][1] *= s_lat;

//scale top right
coordinates[1][0] *= s_lng;
coordinates[1][1] *= s_lat;

//scale bottom right
coordinates[2][0] *= s_lng;
coordinates[2][1] *= s_lat;

//scale bottom left
coordinates[3][0] *= s_lng;
coordinates[3][1] *= s_lat;

//move left
var move_left = 0.004;
coordinates[0][0] -= move_left;
coordinates[1][0] -= move_left;
coordinates[2][0] -= move_left;
coordinates[3][0] -= move_left;

//move down
var move_down = 0.0001;
coordinates[0][1] -= move_down;
coordinates[1][1] -= move_down;
coordinates[2][1] -= move_down;
coordinates[3][1] -= move_down;
  

//generate our dataset
//TODO: load our dataset from json
masks = [];
for (var i = 0; i < 200; i += 10){
  var istr = i.toString();
  var d = {
    source:"source_"+istr,
    id:"image_"+istr,
    url:"/masks/seattle_"+istr+".png",
    coordinates: coordinates,
  }
  masks.push(d);
}

console.log(masks);

map.on('load', function () {
  
  //add each of our masks
  for (var i = 0; i < masks.length; i++){
    var d = masks[i];
    
    //add images
    map.addSource(d["source"], {
    "type": "image",
    "url": d["url"],
    "coordinates": d["coordinates"],
    });
    
    map.addLayer({
    "id": d["id"],
    "source": d["source"],
    "type": "raster",
    "layout":{
      "visibility":"none",
    },
    "paint": {
      "raster-opacity": 0.5
      }
    });
  }



  var first_mask_id = masks[0]["id"];  

  let prev_idg = first_mask_id;
  //set our initial layer as visible
  map.setLayoutProperty(prev_idg, 'visibility', 'visible');

  document
    .getElementById('slider')
    .addEventListener('input', function (e) {
      var meters = parseInt(e.target.value, 10);
      meters *= 10; //scale meters by our increment value 
      map.setLayoutProperty(prev_idg, 'visibility', 'none');
      let idg = "image_"+meters.toString();
      console.log(idg);
      map.setLayoutProperty(idg, 'visibility', 'visible');
      prev_idg = idg;
    });
  
 

  // contours to map
  map.addSource('contours', {
    type: 'vector',
    url: 'mapbox://mapbox.mapbox-terrain-v2'
  });
  map.addLayer({
    'id': 'contours',
    'type': 'line',
    'source': 'contours',
    'source-layer': 'contour',
    'layout': {
    // make layer visible by default
      'visibility': 'visible',
      'line-join': 'round',
      'line-cap': 'round'
    },
    'paint': {
      'line-color': '#877b59',
      'line-width': 1
    }
  });



});  
  

var marker = new mapboxgl.Marker({
  'color': '#314ccd'
});
  

function getElevation() {
  // make API request
  var query = 'https://api.mapbox.com/v4/mapbox.mapbox-terrain-v2/tilequery/' + lng + ',' + lat + '.json?layers=contour&limit=50&access_token=' + mapboxgl.accessToken;
  $.ajax({
    method: 'GET',
    url: query,
  }).done(function(data) {
    // Display the longitude and latitude values
    lngDisplay.textContent = lng.toFixed(2);
    latDisplay.textContent = lat.toFixed(2);
    // Get all the returned features
    var allFeatures = data.features;
    // Create an empty array to add elevation data to
    var elevations = [];
    // For each returned feature, add elevation data to the elevations array
    for (i = 0; i < allFeatures.length; i++) {
      elevations.push(allFeatures[i].properties.ele);
    }
    // In the elevations array, find the largest value
    var highestElevation = Math.max(...elevations);
    // Display the largest elevation value
    eleDisplay.textContent = highestElevation + ' meters';
  });
}

// Create variables for the latitude and longitude
var lng;
var lat;

map.on('click', function(e) {
  // When the map is clicked, set the lng and lat variables equal to the lng and lat properties in the returned lngLat object
  lng = e.lngLat.lng;
  lat = e.lngLat.lat;
  //ele = e.lngLat.ele;
  getElevation();
  marker.setLngLat(e.lngLat).addTo(map);

});
var lngDisplay = document.getElementById('lng');
var latDisplay = document.getElementById('lat');
var eleDisplay = document.getElementById('ele');
  
  
</script>
 
</body>
</html>