<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Display a map</title>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Goldman&display=swap" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/style.css">


</head>
<body>

<!-- background: linear-gradient(to right, #fca107, #7f3121); -->  
<div id="map" class="map"></div>

<div id="control_panel" class="control_panel" >
        
        <h2>Sea Rise: <span id="numMeters">0</span> Meters | <span id="numFeet">0</span> Feet</h2>
        <input id="slider" class="seaSlider" type="range" min="0" max="80" step="1" value="0" />
        <button
          id="hideButton"
          onclick="expandPanel()"
        >Expand + </button>

        <br></br>
        <button onclick="displayWidget(1)">Widget 1</button>
        <button onclick="displayWidget(2)">Widget 2</button>
        <button onclick="displayWidget(3)">Widget 3</button>
        <button onclick="displayWidget(4)">Widget 4</button>

        <div id="legend" class="legend">
          <div class="bar"></div>
          
          <div id="chart1">chart 1</div>
          <div id="chart2">chart 2</div>
          <div id="chart3">chart 3</div>
          <div id="chart4">chart 4</div>
        </div>
    </div>
  
</div> 
  

<script>

//expand or hide control panel widgets
var hidden = true;
expandPanel = function() {
    var div = document.getElementById("control_panel");
    var button = document.getElementById("hideButton");
    if (hidden === false){
      hidden = true;
      div.style.height = "110px";
      button.innerText = "Expand +"
    } else{
      hidden = false;
      div.style.height = "620px";
      button.innerText = "Hide -"
    }
};

//initially set all charts as invisible (except 1)
var c1 = document.getElementById("chart1");
var c2 = document.getElementById("chart2");
var c3 = document.getElementById("chart3");
var c4 = document.getElementById("chart4");

c2.style.display = "none";
c3.style.display = "none";
c4.style.display = "none";

//display / switch which widget is visible
displayWidget = function(x){
  
  c1.style.display = "none";
  c2.style.display = "none";
  c3.style.display = "none";
  c4.style.display = "none";

  switch(x) {
  case 1:
    c1.style.display = "block";
    break;
  case 2:
    c2.style.display = "block";
    break;
  case 3:
    c3.style.display = "block";
    break;
  case 4:
    c4.style.display = "block";
    break;
  default:
    // code block
    break;
  }
};


//MAPBOX SETUP
	mapboxgl.accessToken = 'pk.eyJ1IjoiZXNjYWRhd2ciLCJhIjoiY2tmdmdrZGhkMTYzZDJ6czMyNWo0eWZmNCJ9.XAG-cdhWcLN2IEFAP6bCbg';
var map = new mapboxgl.Map({
container: 'map', // container id
//style: 'mapbox://styles/mapbox/streets-v11', // style URL
style: 'mapbox://styles/mapbox/satellite-streets-v11',
center: [-122.34, 47.61], // starting position [lng, lat]
zoom: 13, // starting zoom
pitch: 60
});


//SETUP MASKS VIA COORDINATES
coordinates = [
  [-122.44, 47.71], //top_left
  [-122.24, 47.71], //top_right
  [-122.24, 47.51], //bottom_right
  [-122.44, 47.51], //bottom_left
];

//stretch our image
var t_lng = 0.0335; //stretches left and right
var t_lat = 0.032; //stretches up and down

//translate top_left
coordinates[0][0] -= t_lng;
coordinates[0][1] += t_lat;

//translate top right
coordinates[1][0] += t_lng;
coordinates[1][1] += t_lat;

//translate bottom right 
coordinates[2][0] += t_lng;
coordinates[2][1] -= t_lat;

//translate bottom left
coordinates[3][0] -= t_lng;
coordinates[3][1] -= t_lat;

//move left
var move_left = 0.004;
coordinates[0][0] -= move_left;
coordinates[1][0] -= move_left;
coordinates[2][0] -= move_left;
coordinates[3][0] -= move_left;

//move down
var move_down = 0.0001;
coordinates[0][1] -= move_down;
coordinates[1][1] -= move_down;
coordinates[2][1] -= move_down;
coordinates[3][1] -= move_down;
  

//generate our dataset
//TODO: load our dataset from json
masks = [];
for (var i = 0; i < 80; i += 1){
  var istr = i.toString();
  var d = {
    source:"source_"+istr,
    id:"image_"+istr,
    url:"/masks/seattle_"+istr+".png",
    coordinates: coordinates,
  }
  masks.push(d);
}

map.on('load', function () {
  
  //add each of our masks
  for (var i = 0; i < masks.length; i++){
    var d = masks[i];
    
    //add images
    map.addSource(d["source"], {
    "type": "image",
    "url": d["url"],
    "coordinates": d["coordinates"],
    });
    
    map.addLayer({
    "id": d["id"],
    "source": d["source"],
    "type": "raster",
    "layout":{
      "visibility":"none",
    },
    "paint": {
      "raster-opacity": 0.5
      }
    });
  }


  var first_mask_id = masks[0]["id"];  

  let prev_idg = first_mask_id;
  //set our initial layer as visible
  //map.setLayoutProperty(prev_idg, 'visibility', 'visible');



  document
    .getElementById('slider')
    .addEventListener('input', function (e) {
      var meters = parseInt(e.target.value, 10);
      var numMeters = document.getElementById("numMeters");
      numMeters.textContent = meters;
      var numFeet = document.getElementById("numFeet");
      var feet = meters * 3.281; //approximate conversion from 
      numFeet.textContent = feet.toFixed(1);

      map.setLayoutProperty(prev_idg, 'visibility', 'none');
      if (meters > 0){
        meters -= 1; 
        let idg = "image_"+meters.toString();
        console.log(idg);
        map.setLayoutProperty(idg, 'visibility', 'visible');
        prev_idg = idg;
      }
      
    });
  
 

  // contours to map
  map.addSource('contours', {
    type: 'vector',
    url: 'mapbox://mapbox.mapbox-terrain-v2'
  });
  map.addLayer({
    'id': 'contours',
    'type': 'line',
    'source': 'contours',
    'source-layer': 'contour',
    'layout': {
    // make layer visible by default
      'visibility': 'visible',
      'line-join': 'round',
      'line-cap': 'round'
    },
    'paint': {
      'line-color': '#877b59',
      'line-width': 1
    }
  });

});  
  

  
</script>


 
</body>
</html>